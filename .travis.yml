language: php
sudo: false

cache:
  directories:
    - $HOME/.composer

php:
  - 5.6
  - 7.0
  - 7.1
  - nightly
  - hhvm

env:
  - PHPUNIT=4.7.*     # EOL August 7, 2016
  - PHPUNIT=4.8.*     # EOL August 7, 2016
  - PHPUNIT=5.0.*     # EOL February 3, 2017
  - PHPUNIT=5.1.*     # EOL February 3, 2017
  - PHPUNIT=5.2.*     # EOL February 2, 2018
  - PHPUNIT=5.3.*     # EOL February 2, 2018
  - PHPUNIT=5.4.*     # EOL February 2, 2018
  - PHPUNIT=5.5.*     # EOL February 2, 2018
  - PHPUNIT=5.6.*     # EOL February 2, 2018
  - PHPUNIT=5.7.*     # EOL February 2, 2018
  - PHPUNIT=^6.0      # EOL February 2, 2018

matrix:
  exclude:
    - php: 5.6
      env: PHPUNIT=^6.0
    - php: hhvm
      env: PHPUNIT=^6.0
  include:
    - php: 5.6
      env: 
        - COMPOSER_OPTIONS="--prefer-lowest"
    - php: 5.6
      env: 
        - TEST_COVERAGE=true
  allow_failures:
    - php: hhvm
    - php: nightly
  fast_finish: true

install:
  - if [[ ! $TEST_COVERAGE ]]; then phpenv config-rm xdebug.ini; fi
  - if [[ $TEST_COVERAGE ]]; then PHPUNIT_FLAGS="--coverage-clover ./build/logs/clover.xml"; fi
  - composer config minimum-stability dev
  - composer require phpunit/phpunit:${PHPUNIT} --no-update
  - composer update --prefer-dist --prefer-stable --no-interaction $COMPOSER_OPTIONS

script:
  - bin/phpunit -v $PHPUNIT_FLAGS
  - src/Paraunit/Bin/paraunit run # self-consistency test

after_success:
  - if [[ $TEST_COVERAGE ]]; then php bin/coveralls -v; fi
  - if [[ $TEST_COVERAGE ]]; then wget https://scrutinizer-ci.com/ocular.phar && php ocular.phar code-coverage:upload --format=php-clover ./build/logs/clover.xml; fi
  - if [[ $TEST_COVERAGE ]]; then bin/test-reporter; fi
